---
title: "Racial and Ethnic differences in O2 flow"
output:
  html_document:
    df_print: paged
---

Qualitatively replicate the results of the [Assessment of Racial and Ethnic Differences in Oxygen Supplementation Among Patients in the Intensive Care Unit](https://jamanetwork.com/journals/jamainternalmedicine/fullarticle/2794196) study

Analysis of the differences in oxygen delivery rates by race and ethnicity.

See "Result/Factors Associated With Oxygen Delivery Rates" and [Figure 2b](https://cdn.jamanetwork.com/ama/content_public/journal/intemed/938956/ioi220037f2_1658163803.93993.png?Expires=1727754938&Signature=SCd44KsPUjxQ6hsuUJ0x7qlEB5-ncz6eQJCzwpoCyqMx7z6FUoIpMfuOi2nqrjHa3fFne~yJc8k0-uGsM375mBzYediN69rOfHMnA80YiOWbudsxrn6OPgxdknjGnlcuzWao1KAe0uZZWIv~KDSp-ngPZqYdoUC2GDSS687NdULlQg3bv0Ua6DAtjEhdPz0ePlAg6RSm8h~QH6xdlTDaN04NCzfVCWZOMPgvq0YjEYMAeCKR8hTxWHVh~z4XKNcZnXD9dPv5Z588aXGVFuGPMl9xc0vrGczA7JSrihoRc7YJyDrhN60R24JWVYcrZlUEsoDCgGKKseCjIoFj7IvbCA__&Key-Pair-Id=APKAIE5G5CRDK6RD3PGA) in the original paper.

Assumption/Differences:

- For Wilcoxon test we  assume "greater" alternative hypothesis, i.e. the O2 flow is higher for WHITE patients. This is not explicitly stated in the original paper, but it is a reasonable assumption given the context.

## Data processing

Initialize

```{r init, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_knit$set(root.dir = '../')
```
```{r setup, message=FALSE, warning=FALSE}
library(lubridate)
library(MLmetrics)
library(dplyr)
library(ggplot2)
source('R/functions.R')
```

Load subject and o2 flow data:

```{r load_data}
subject_df <- load_subject('data/fhir_mimic-2.2/subject.csv')
reading_o2_flow_df <- load_reading('data/fhir_mimic-2.2/reading_o2_flow.csv')
```

Compute the average o2 flow for each subject and join with the subject data:

```{r process_data}
avg_o2_flow_df <- reading_o2_flow_df %>%
  arrange(subject_id, chart_time) %>%
  group_by(subject_id) %>%
  group_modify(~ data.frame(o2_flow = avg_reading(.x$chart_time, .x$o2_flow))) %>%
  filter(o2_flow < 20)  %>% filter(o2_flow > 0) %>%# remove outliers TODO: fix in the data export
  ungroup()

subject_with_o2_flow_df <- subject_df %>% inner_join(avg_o2_flow_df, by='subject_id')
summary(subject_with_o2_flow_df)
```

## Analysis

### Compare O2 flow by race/ethnicity

```{r compare_table}
iqr_df <- subject_with_o2_flow_df %>%
  group_by(race_category) %>%
  summarize(
    count = n(),
    mean = mean(o2_flow),
    Q1 = quantile(o2_flow, .25),
    median = quantile(o2_flow, .5),
    Q3 = quantile(o2_flow, .75),
    IQR = IQR(o2_flow, na.rm = TRUE)
  )
iqr_df
```

```{r compare_chart}
(ggplot(subject_with_o2_flow_df, aes(x=race_category, y=o2_flow, colour = race_category))
  + geom_boxplot()
  + labs(x = "Race and ethnicity", y = "Average oxygen rate [L/min]", title = "Oxygen delivery rates by race and ethnicity")
)

```

### Test for differences in mean O2 flow by race/ethnicity

Test for differences in mean O2 flow against ‘WHITE’ using unpaired non-parametric Wilcoxon test.

#### Black vs White

```{r test_white_black}
wc_white_black <- wilcox.test(o2_flow ~ race_category, alternative = 'greater',
                       data = subject_with_o2_flow_df %>% filter(race_category %in% c('WHITE', 'BLACK') ))
wc_white_black
```

#### Asian vs White

```{r test_white_asian}
wc_white_asian <- wilcox.test(o2_flow ~ race_category, alternative = 'greater',
                       data = subject_with_o2_flow_df %>% filter(race_category %in% c('WHITE', 'ASIAN') ))
wc_white_asian
```

#### Hispanic vs White

```{r test_white_hispanic}
wc_white_hispanic <- wilcox.test(o2_flow ~ race_category, alternative = 'greater',
                       data = subject_with_o2_flow_df %>% filter(race_category %in% c('WHITE', 'HISPANIC') ))
wc_white_hispanic
```

## Discussion

Like on the original paper, we found that the average oxygen flow rate was higher for white patients compared to non white patients. The difference was statistically significant for black (p = `r wc_white_black$p.value`), asian (p = `r wc_white_asian$p.value`) and hispanic (p = `r wc_white_hispanic$p.value`) patients.
