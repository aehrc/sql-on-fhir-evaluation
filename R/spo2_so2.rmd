---
title: "Racial and Ethnic differences in O2 flow"
output:
  html_document:
    df_print: paged
---

Qualitatively replicate the results of the [Assessment of Racial and Ethnic Differences in Oxygen Supplementation Among Patients in the Intensive Care Unit](https://jamanetwork.com/journals/jamainternalmedicine/fullarticle/2794196) study

Analysis of the differences in oxygen delivery rates by race and ethnicity.

See "Result/Factors Associated With Oxygen Delivery Rates" and [Figure 2b](https://cdn.jamanetwork.com/ama/content_public/journal/intemed/938956/ioi220037f2_1658163803.93993.png?Expires=1727754938&Signature=SCd44KsPUjxQ6hsuUJ0x7qlEB5-ncz6eQJCzwpoCyqMx7z6FUoIpMfuOi2nqrjHa3fFne~yJc8k0-uGsM375mBzYediN69rOfHMnA80YiOWbudsxrn6OPgxdknjGnlcuzWao1KAe0uZZWIv~KDSp-ngPZqYdoUC2GDSS687NdULlQg3bv0Ua6DAtjEhdPz0ePlAg6RSm8h~QH6xdlTDaN04NCzfVCWZOMPgvq0YjEYMAeCKR8hTxWHVh~z4XKNcZnXD9dPv5Z588aXGVFuGPMl9xc0vrGczA7JSrihoRc7YJyDrhN60R24JWVYcrZlUEsoDCgGKKseCjIoFj7IvbCA__&Key-Pair-Id=APKAIE5G5CRDK6RD3PGA) in the original paper.

Assumption/Differences:


## Data processing

Initialize

```{r init, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_knit$set(root.dir = '../')
```
```{r setup, message=FALSE, warning=FALSE}
library(lubridate)
library(MLmetrics)
library(dplyr)
library(ggplot2)
source('R/functions.R')
```

Load subject and o2 flow data:

```{r load_data}
subject_df <- load_subject('data/psql_mimic-2.2/subject.csv')
reading_so2_df <- load_reading('data/psql_mimic-2.2/reading_so2.csv')
reading_spo2_df <- load_reading('data/psql_mimic-2.2/reading_spo2.csv')
```

Compute the average spo2 and so2 for each subject and join with the subject data:

```{r process_data}
avg_so2_df <- reading_so2_df %>%
  filter(so2 > 70) %>%
  arrange(subject_id, chart_time) %>%
  group_by(subject_id) %>%
  group_modify(~ data.frame(so2 = avg_reading(.x$chart_time, .x$so2))) %>%
  ungroup()

avg_spo2_df <- reading_spo2_df %>%
  arrange(subject_id, chart_time) %>%
  group_by(subject_id) %>%
  group_modify(~ data.frame(spo2 = avg_reading(.x$chart_time, .x$spo2))) %>%
  ungroup()


subject_with_so2_df <- subject_df %>% inner_join(avg_so2_df, by='subject_id') %>% inner_join(avg_spo2_df, by='subject_id')
summary(subject_with_so2_df)
```

## Analysis

### Compare O2 flow by race/ethnicity

```{r compare_table}
print(
  ggplot(subject_with_so2_df, aes(x=so2, y=spo2))
    + geom_point()
    + geom_smooth(aes(colour = race_category), se = FALSE, method='gam')
)

```

### Linear model

```{r compare_chart}
spo2_lm <-lm(spo2 ~  so2 + race_category + gender, data = subject_with_so2_df)
print(summary(spo2_lm))
```

Anova
```{r anova}
print(anova(spo2_lm))
```

## Discussion

Like on the original paper ...
